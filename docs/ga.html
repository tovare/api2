<!DOCTYPE html>

<html>
<head>
  <title>ga.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="README.html">
                  README.md
                </a>
              
                
                <a class="source" href="TODO.html">
                  TODO.md
                </a>
              
                
                <a class="source" href="analytics.html">
                  analytics.js
                </a>
              
                
                <a class="source" href="ga.html">
                  ga.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ga.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> garouter = express.Router()

<span class="hljs-keyword">var</span> google = <span class="hljs-built_in">require</span>(<span class="hljs-string">'googleapis'</span>);
<span class="hljs-keyword">var</span> analytics = google.analytics(<span class="hljs-string">'v3'</span>);
<span class="hljs-keyword">var</span> OAuth2Client = google.auth.OAuth2;
<span class="hljs-keyword">var</span> jsonfile = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonfile'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> key = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../private/dashboard-9ffb13a69a61.json'</span>)
<span class="hljs-keyword">var</span> reports = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./reports.json'</span>)
<span class="hljs-keyword">var</span> scopes = [<span class="hljs-string">"https://www.google.com/analytics/feeds"</span>]
<span class="hljs-keyword">var</span> jwtClient = <span class="hljs-keyword">new</span> google.auth.JWT(key.client_email, <span class="hljs-literal">null</span>, key.private_key, scopes, <span class="hljs-literal">null</span>);

<span class="hljs-keyword">var</span> d3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'d3'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>LokiJS is a high-performance in-memory document database which prioritise performance over anything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> loki = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lokijs'</span>);
<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> loki(<span class="hljs-string">"public/data/rtdb.json"</span>, {
    <span class="hljs-string">'autoload'</span> : <span class="hljs-literal">true</span>,
    <span class="hljs-string">'autosave'</span> : <span class="hljs-literal">true</span>,
    <span class="hljs-string">'verbose'</span> : <span class="hljs-literal">true</span>  });
<span class="hljs-keyword">var</span> rtdb = db.addCollection(<span class="hljs-string">"rtdb"</span>);

<span class="hljs-keyword">var</span> counter = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> countlev = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">var</span> analyticProfiles = [</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>   “ga:78449289”,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-string">"ga:95726205"</span>,
      <span class="hljs-string">"ga:95718980"</span>,
      <span class="hljs-string">"ga:95719958"</span>
    ];


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryAllRealtime</span>(<span class="hljs-params">analytics, reports</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TODO: Check if realtime or not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>


  counter = counter <span class="hljs-number">-1</span>;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Counter was reduced by one and is now "</span> + counter)
  reports[<span class="hljs-string">"reports"</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">query</span>)</span>{

  
    <span class="hljs-keyword">if</span>(counter &lt;= <span class="hljs-number">0</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Prepare a query object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> shuffleResult = d3.shuffle(analyticProfiles);
      <span class="hljs-keyword">var</span> a = query[<span class="hljs-string">"query"</span>];
      a.auth = jwtClient;
      a.ids = analyticProfiles[<span class="hljs-number">0</span>];
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Requesting using profile "</span> + analyticProfiles[<span class="hljs-number">0</span>] + <span class="hljs-string">"The current list is"</span> + <span class="hljs-built_in">JSON</span>.stringify(analyticProfiles) + <span class="hljs-string">" the shuffle result was "</span> + shuffleResult);

      analytics.data.realtime.get(a,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, response</span>)</span>{
        <span class="hljs-keyword">if</span>(err){
          <span class="hljs-built_in">console</span>.log(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>BACKOFF STRATEGY. WE NEED TO STOP QUERIES FOR A WHILE.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          countlev = countlev + <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span>(countlev &gt;= <span class="hljs-number">40</span>) {
            countlev = <span class="hljs-number">40</span>;
          }
          counter = countlev;
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"FAILED ATTEMPT. COUNTER IS "</span> + counter);
          <span class="hljs-keyword">return</span>;
        }
        countlev = <span class="hljs-number">1</span>;
        counter = <span class="hljs-number">1</span>;

          <span class="hljs-keyword">var</span> doc = rtdb.findOne({<span class="hljs-string">'name'</span>: query.name });
          <span class="hljs-keyword">if</span>(!doc){
              doc = rtdb.insert({ <span class="hljs-string">"name"</span> : query.name } );
          }
          doc.response = response;
          rtdb.update(doc);
      });
    }
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Authorize client. This is done on startup, but it might be necessary to do this more often.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>jwtClient.authorize(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, tokens</span>) </span>{
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.log(err);
    <span class="hljs-keyword">return</span>;
  }
  queryAllRealtime(analytics,reports);
  d3.interval( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ queryAllRealtime(analytics,reports) }, <span class="hljs-number">10000</span>);

  
});</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="request-handling-code">REQUEST HANDLING CODE</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>All of the data is memory resident. The request methods retrieve 
data from the Loki database.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

garouter.get(<span class="hljs-string">'/rtusers'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> rtusers = rtdb.findOne( { <span class="hljs-string">'name'</span>: <span class="hljs-string">'brukere-realtime'</span> })
    res.json(rtusers.response.totalsForAllResults);
    
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Request rtusers"</span>);
})

garouter.get(<span class="hljs-string">'/rtgeo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> rtgeo = rtdb.findOne( { <span class="hljs-string">'name'</span>: <span class="hljs-string">'brukere-geo-realtime'</span> })
    res.json(rtgeo.response.rows)
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Request rtusers"</span>);
})

garouter.get(<span class="hljs-string">'/rtdevices'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">var</span> redevices = rtdb.findOne( { <span class="hljs-string">'name'</span>: <span class="hljs-string">'brukere-device-realtime'</span> });
  res.json(redevices.response.rows);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Request rtdevices"</span>);
})

<span class="hljs-built_in">module</span>.exports = garouter</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
